# 다국어 지원 (Internationalization)

맑은프레임워크의 Message 클래스는 다국어 웹 애플리케이션을 구축하기 위한 국제화(i18n) 기능을 제공합니다.

## 목차

- [기본 개념](#기본-개념)
- [메시지 파일 구조](#메시지-파일-구조)
- [Message 클래스 사용](#message-클래스-사용)
- [동적 메시지](#동적-메시지)
- [캐시 및 성능](#캐시-및-성능)

---

## 기본 개념

### 다국어 처리 방식

Message 클래스는 properties 파일 기반의 다국어 메시지 시스템을 제공합니다:

- **메시지 파일**: 키-값 쌍으로 메시지 저장
- **로케일 지원**: 언어별 메시지 파일 관리
- **폴백 처리**: 해당 언어에 메시지가 없으면 기본 언어로 대체
- **메모리 캐싱**: 성능을 위한 자동 캐싱

---

## 메시지 파일 구조

### 파일 위치

기본 경로: `/WEB-INF/message/`

설정 변경:
```jsp
Config.set("msgDir", "/custom/message/path");
```

### 파일 명명 규칙

```
/WEB-INF/message/
  ├── message.properties          (기본 언어)
  ├── message_en.properties       (영어)
  ├── message_ko.properties       (한국어)
  ├── message_ja.properties       (일본어)
  └── message_zh.properties       (중국어)
```

### 메시지 파일 형식

**message.properties** (기본 - 한국어)
```properties
# 사용자 인터페이스
welcome=환영합니다
login=로그인
logout=로그아웃
name=이름
email=이메일
password=비밀번호

# 에러 메시지
error.required=필수 항목입니다
error.invalid_email=올바른 이메일 주소를 입력하세요
error.password_mismatch=비밀번호가 일치하지 않습니다

# 시스템 메시지
sysop.book_insert.specify_books=도서를 선택해주세요
main.log=사용자 {0}이(가) {1}에 로그인했습니다
```

**message_en.properties** (영어)
```properties
welcome=Welcome
login=Login
logout=Logout
name=Name
email=Email
password=Password

error.required=This field is required
error.invalid_email=Please enter a valid email address
error.password_mismatch=Passwords do not match

sysop.book_insert.specify_books=Please select books
main.log=User {0} logged in at {1}
```

**message_ko.properties** (한국어)
```properties
welcome=환영합니다
login=로그인
logout=로그아웃
```

---

## Message 클래스 사용

### 기본 사용법

```jsp
<%@ page contentType="text/html; charset=utf-8" %><%@ include file="/init.jsp" %><%

// 기본 로케일로 Message 객체 생성
Message msg = new Message();

// 메시지 가져오기
String welcome = msg.get("welcome");      // "환영합니다"
String login = msg.get("login");          // "로그인"

m.p(welcome);
m.p(login);

%>
```

### 로케일 지정

```jsp
// 영어로 설정
Message msg = new Message("en");
m.p(msg.get("welcome"));  // "Welcome"

// 또는 setLocale 사용
Message msg = new Message();
msg.setLocale("en");
m.p(msg.get("welcome"));  // "Welcome"

msg.setLocale("ko");
m.p(msg.get("welcome"));  // "환영합니다"
```

### 기본값 처리

```jsp
Message msg = new Message();

// 메시지가 없으면 키를 반환
String unknown = msg.get("unknown.key");  // "unknown.key"

// 사용자 정의 기본값
String custom = msg.get("unknown.key", "기본 메시지");  // "기본 메시지"
```

---

## 동적 메시지

### 매개변수가 있는 메시지

**message.properties**
```properties
user.greeting=안녕하세요, {0}님!
order.confirm=주문 {0}개 상품이 {1}원에 결제되었습니다
```

**JSP 코드**
```jsp
Message msg = new Message();

// MessageFormat 스타일 ({0}, {1}, ...)
String greeting = msg.format("user.greeting", "홍길동");
// "안녕하세요, 홍길동님!"

String confirm = msg.format("order.confirm", 3, 50000);
// "주문 3개 상품이 50000원에 결제되었습니다"
```

### 플레이스홀더 치환

**message.properties**
```properties
email.template=안녕하세요 {{name}}님, {{product}} 주문이 완료되었습니다.
```

**JSP 코드**
```jsp
Message msg = new Message();

String[] params = {
    "name=>홍길동",
    "product=>맥북 프로"
};

String email = msg.get("email.template", params);
// "안녕하세요 홍길동님, 맥북 프로 주문이 완료되었습니다."
```

---

## 배열과 Map 처리

### 배열 메시지

```jsp
Message msg = new Message();

String[] keys = {
    "status.0=>pending",
    "status.1=>approved",
    "status.2=>rejected"
};

String[] messages = msg.getArray(keys);
// ["status.0=>대기중", "status.1=>승인됨", "status.2=>거부됨"]
```

### Map 메시지

```jsp
Map<String, String> map = new HashMap<>();
map.put("title", "welcome");
map.put("subtitle", "login");

Map<String, String> translated = msg.getMap(map);
// {"title":"환영합니다", "subtitle":"로그인"}
```

---

## 캐시 및 성능

### 메모리 캐싱

Message 클래스는 메시지 파일을 메모리에 캐싱하여 성능을 최적화합니다.

```jsp
Message msg = new Message();

// 첫 번째 호출: 파일에서 로드 및 캐싱
String text1 = msg.get("welcome");

// 두 번째 호출: 캐시에서 가져옴 (빠름)
String text2 = msg.get("login");
```

### 캐시 새로고침

메시지 파일을 수정한 후 변경사항을 반영하려면:

```jsp
Message msg = new Message();

// 특정 로케일 캐시 재로드
msg.reload("en");

// 기본 로케일 캐시 재로드
msg.reload();

// 모든 로케일 캐시 재로드
msg.reloadAll();
```

---

## 실제 사용 예제

### 다국어 웹페이지

**user_profile.jsp**
```jsp
<%@ page contentType="text/html; charset=utf-8" %><%@ include file="/init.jsp" %><%

// 사용자 언어 설정 가져오기 (쿠키, 세션, 또는 파라미터에서)
String lang = m.cookie("lang");
if(lang == null || lang.isEmpty()) lang = "default";

Message msg = new Message(lang);

p.setBody("user.profile");
p.setVar("msg", msg);
p.display();

%>
```

**html/user/profile.html**
```html
<!DOCTYPE html>
<html>
<head>
    <title>{{msg.get("page.title")}}</title>
</head>
<body>
    <h1>{{msg.get("user.profile")}}</h1>

    <form>
        <label>{{msg.get("name")}}</label>
        <input type="text" name="name" />

        <label>{{msg.get("email")}}</label>
        <input type="email" name="email" />

        <label>{{msg.get("password")}}</label>
        <input type="password" name="password" />

        <button>{{msg.get("save")}}</button>
    </form>
</body>
</html>
```

### 폼 검증 메시지

**message.properties**
```properties
validation.required={0}은(는) 필수 항목입니다
validation.email=올바른 이메일 주소를 입력하세요
validation.minlength={0}은(는) 최소 {1}자 이상이어야 합니다
```

**login.jsp**
```jsp
<%@ page contentType="text/html; charset=utf-8" %><%@ include file="/init.jsp" %><%

Message msg = new Message();

f.addElement("email", null, "required:Y, email:Y");
f.addElement("password", null, "required:Y, minlength:8");

if(m.isPost() && !f.validate()) {
    // 에러 메시지를 다국어로 변환
    String emailError = msg.format("validation.email");
    String passwordError = msg.format("validation.minlength", "비밀번호", 8);

    m.jsError(f.getErrorString());
    return;
}

// 로그인 처리...

%>
```

### 동적 알림 메시지

**message.properties**
```properties
notification.new_message={0}님으로부터 새 메시지가 도착했습니다
notification.order_shipped=주문 #{0}이(가) 발송되었습니다. 운송장번호: {1}
notification.password_changed=비밀번호가 {0}에 변경되었습니다
```

**notification.jsp**
```jsp
Message msg = new Message();

// 새 메시지 알림
String sender = "홍길동";
String notification1 = msg.format("notification.new_message", sender);
// "홍길동님으로부터 새 메시지가 도착했습니다"

// 배송 알림
String notification2 = msg.format("notification.order_shipped", "A123456", "1234-5678-9012");
// "주문 #A123456이(가) 발송되었습니다. 운송장번호: 1234-5678-9012"

// 비밀번호 변경 알림
String notification3 = msg.format("notification.password_changed", Malgn.time("yyyy-MM-dd HH:mm"));
// "비밀번호가 2025-10-23 14:30에 변경되었습니다"
```

---

## 언어 전환 구현

### 언어 선택 UI

```jsp
<%@ page contentType="text/html; charset=utf-8" %><%@ include file="/init.jsp" %><%

String currentLang = m.cookie("lang");
if(currentLang == null || currentLang.isEmpty()) currentLang = "default";

Message msg = new Message(currentLang);

%>
<div class="language-selector">
    <select onchange="changeLanguage(this.value)">
        <option value="default" <%=currentLang.equals("default") ? "selected" : ""%>>한국어</option>
        <option value="en" <%=currentLang.equals("en") ? "selected" : ""%>>English</option>
        <option value="ja" <%=currentLang.equals("ja") ? "selected" : ""%>>日本語</option>
        <option value="zh" <%=currentLang.equals("zh") ? "selected" : ""%>>中文</option>
    </select>
</div>

<script>
function changeLanguage(lang) {
    document.cookie = "lang=" + lang + "; path=/; max-age=31536000";
    location.reload();
}
</script>
```

### 언어 설정 API

**set_language.jsp**
```jsp
<%@ page contentType="application/json; charset=utf-8" %><%@ include file="/init.jsp" %><%

String lang = m.rs("lang", "default");

// 쿠키에 저장 (1년)
m.setCookie("lang", lang, 365);

// 또는 세션에 저장
session.setAttribute("lang", lang);

j.success("언어가 변경되었습니다");

%>
```

---

## 모범 사례

### 1. 메시지 키 네이밍

계층적 구조 사용:
```properties
# 좋은 예
user.profile.title=프로필
user.profile.edit=프로필 수정
user.settings.password=비밀번호 변경

# 나쁜 예
title=프로필
edit=수정
password=비밀번호
```

### 2. 공통 메시지 재사용

```properties
# 공통 액션
common.save=저장
common.cancel=취소
common.delete=삭제
common.confirm=확인

# 공통 상태
status.active=활성
status.inactive=비활성
status.pending=대기중
```

### 3. UTF-8 인코딩

메시지 파일은 반드시 UTF-8로 저장:
- Eclipse: File > Properties > Text file encoding > UTF-8
- IntelliJ: File > Settings > Editor > File Encodings > UTF-8

### 4. 성능 최적화

```jsp
// 좋은 예: Message 객체 재사용
Message msg = new Message();
for(int i = 0; i < 100; i++) {
    m.p(msg.get("key" + i));
}

// 나쁜 예: 매번 새로 생성
for(int i = 0; i < 100; i++) {
    Message msg = new Message();
    m.p(msg.get("key" + i));
}
```

---

## 주의사항

1. **파일 인코딩**: 메시지 파일은 반드시 UTF-8로 저장
2. **키 일관성**: 모든 언어 파일에 동일한 키 사용
3. **기본 언어**: `message.properties`는 항상 유지 (폴백용)
4. **특수 문자**: `=`, `:`, `#` 등은 이스케이프 필요
   ```properties
   # 올바른 예
   message.with.colon=값\: 설명
   ```

---

## 관련 문서

- [환경설정 및 캐시](configuration.md) - Config 클래스
- [유틸리티 메소드](utility-methods.md) - 문자열 처리
- [템플릿](template.md) - 템플릿에서 다국어 사용
